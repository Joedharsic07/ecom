{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Base Template{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/navbase.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    {% block extra_css %}{% endblock %}
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="bar">
        <div style="display: flex;">
            <div>
                <h5 class="name">Style Haven</h5>
            </div>
            <div>
                <ul class="bar-ul">
                    <li class="nav-item">
                        <a class="nav-link-1" href="{% url 'home' %}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link-1" href="{% url 'men' %}">Men</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link-1" href="{% url 'women' %}">Women</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link-1" href="{% url 'kids' %}">Kids</a>
                    </li>
                </ul>
            </div>
        </div>
        <div>
            <div style="display: flex; align-items: center;">
                <div class="InputContainer" style="margin-right: 10px; border-radius: 10px;">
                    <input placeholder="Search" id="search-bar" class="input" name="text" type="text" />
                    <label class="labelforsearch" for="input">
                        <svg class="searchIcon" viewBox="0 0 512 512">
                            <path
                                d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z" />
                        </svg>
                    </label>
                </div>
                <!-- <div>
                    <i class="fas fa-user profile-icon"></i>
                </div> -->
                <div class="box">
                    <div id="cart-count">0</div>
                    <i class="fa-solid fa-cart-shopping"></i>
                </div>
                <div class="cart">
                    <div class="cart-title"> Cart Items </div>
                    <div class="cart-content"></div>
                    <div class="total">
                        <div class="total-title">Total</div>
                        <div class="total-price">Rs.0</div>

                    </div>
                    <!-- <button class="btn-buy">Place Order</button> -->
                    <i class="fa fa-window-close" aria-hidden="true" id="cart-close"></i>
                </div>
            </div>
        </div>
        <div class="dropdown profile-dropdown">
            {% if user.is_authenticated %}
                <div class="d-flex align-items-center" id="dropdownMenuButton" data-bs-toggle="dropdown">
                    <img src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}{% static 'imag/default_profile_pic.jpg' %}{% endif %}" 
                         alt="Profile Picture" class="rounded-circle profile-picture" width="40" height="40">                    
                    <span class="username">
                        {% if user.username %}
                            {{ user.username }}
                        {% else %}
                            {{ user.email }}
                        {% endif %}
                    </span>
                </div>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                    <li>
                        <a class="dropdown-item" href="{% url 'profile' %}">
                            <i class="fas fa-user me-2"></i> Profile
                        </a>
                    </li>
                    <li>
                        <a id="changePasswordLink" class="dropdown-item" href="#">
                            <i class="fas fa-lock me-2"></i> Change Password
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{% url 'logout' %}">
                            <i class="fas fa-sign-out-alt me-2"></i> Logout
                        </a>
                    </li>
                </ul>
            {% endif %}
        </div>
    </div>

    <div>
        {% block content %}
        {% endblock %}
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <form id="changePasswordForm">
            {% csrf_token %}
            <div class="login-text">Change Password</div>

            <label for="currentPassword" class="user-pass">Old Password</label>
            <div class="password-container">
              <input type="password" id="currentPassword" name="old_password" class="inputs"
                placeholder="Enter your Old password">
              <button type="button" id="toggleCurrentPassword" class="toggle-button">
                <i class="fa fa-eye-slash"></i>
              </button>
            </div>
            <div id="oldPasswordError" class="text-danger"></div>

            <label for="newPassword" class="user-pass">New Password</label>
            <div class="password-container">
              <input type="password" id="newPassword" name="new_password1" class="inputs"
                placeholder="Enter new password">
              <button type="button" id="toggleNewPassword" class="toggle-button">
                <i class="fa fa-eye-slash"></i>
              </button>
            </div>
            <div id="newPasswordError" class="text-danger"></div>
            <div id="newPasswordLengthError" class="text-danger"></div>

            <label for="confirmPassword" class="user-pass">Confirm Password</label>
            <div class="password-container">
              <input type="password" id="confirmPassword" name="new_password2" class="inputs"
                placeholder="Confirm new password">
              <button type="button" id="toggleConfirmPassword" class="toggle-button">
                <i class="fa fa-eye-slash"></i>
              </button>
            </div>

            <button class="button" type="submit">Change Password</button>
          </form>
        </div>
      </div>
      
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/script.js' %}"></script>
    
    <script>
   document.getElementById('changePasswordLink').onclick = function (event) {
    event.preventDefault(); 
    document.getElementById('changePasswordModal').style.display = 'block';
};

// Close modal when 'X' is clicked or outside the modal
document.querySelector('.close').onclick = function () {
    document.getElementById('changePasswordModal').style.display = 'none';
};

// Close modal when clicking outside the modal content
window.onclick = function (event) {
    if (event.target === document.getElementById('changePasswordModal')) {
        document.getElementById('changePasswordModal').style.display = 'none';
    }
};

// Toggle password visibility in password fields
document.getElementById('toggleCurrentPassword').onclick = function () {
    let input = document.getElementById('currentPassword');
    togglePassword(input, this);
};

document.getElementById('toggleNewPassword').onclick = function () {
    let input = document.getElementById('newPassword');
    togglePassword(input, this);
};

document.getElementById('toggleConfirmPassword').onclick = function () {
    let input = document.getElementById('confirmPassword');
    togglePassword(input, this);
};

function togglePassword(input, toggleButton) {
    if (input.type === 'password') {
        input.type = 'text';
        toggleButton.innerHTML = '<i class="fa fa-eye"></i>';
    } else {
        input.type = 'password';
        toggleButton.innerHTML = '<i class="fa fa-eye-slash"></i>';
    }
}

    document.getElementById('changePasswordForm').onsubmit = function (event) {
      event.preventDefault();  
      const oldPassword = document.getElementById('currentPassword').value;
      const newPassword1 = document.getElementById('newPassword').value;
      const newPassword2 = document.getElementById('confirmPassword').value;
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      const formData = new FormData();
      formData.append('old_password', oldPassword);
      formData.append('new_password1', newPassword1);
      formData.append('new_password2', newPassword2);

      fetch('{% url "change_password" %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken
        },
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          // Clear previous error messages
          document.querySelectorAll('.text-danger').forEach(el => el.textContent = '');

          if (data.success) {
            // If password change is successful, show success message and close modal
            alert(data.message);
            document.getElementById('changePasswordModal').style.display = 'none';
            // Optionally reload the page or update the UI
            location.reload();
          } else {
            if (data.errors.old_password) {
              document.getElementById('oldPasswordError').textContent = data.errors.old_password;
            }
            if (data.errors.new_password) {
              document.getElementById('newPasswordError').textContent = data.errors.new_password;
            }
            if (data.errors.new_password_length) {
              document.getElementById('newPasswordLengthError').textContent = data.errors.new_password_length;
            }
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
    };
    </script>

    {% block extra_js %}
    {% endblock %}
</body>
</html>
